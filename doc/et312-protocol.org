* ET312 Protocol Documentation
** Introduction

This document is a specification for the serial communications
protocol of the ET312 Electrostimulation box by Erostek. The protocol
was put together through multiple sources:

- Serial monitoring of box communications with various controls
  software
- Mapping from the original erosoutsider perl files
- Message board/Mailing list posts from around the internet

The following specifications are for v1.6 of the Erostek firmware,
which it is assumed all modern boxes are running.

** Protocol and Communication Basics
*** Communication via Link Cable

Communicating with the ET312 box happens via an RS-232 Connection to
the Link port of the box. The link cable consists of a 3.5mm TRS
(stereo audio) jack, going to some sort of computer connection, be it
Female DB-9 or a RS232-to-USB converter. The pin connections are as
follows:

- 3.5mm Tip <-> RX (DB-9 Pin 2)
- 3.5mm Ring <-> TX (DB-9 Pin 3)
- 3.5mm Sleeve <-> Ground (DB-9 Pin 5)

Serial connections are 19200/8/N/1, or:

- 19200 baud
- Data Bits: 8
- Stop Bits: 1
- Partity: None

*** Encryption
Communication with the box is encrypted, using a simple XOR stream
cipher based on keys exchanged during handshake.

** Handshake

*** HELLO (Connection establishment)

Handshaking consists of a byte sent to the box, and a byte received
back:

- 0x00 is sent to ET312
- 0x07 is read from ET312

This exchange only needs to happen once, but can be repeated.

*** XOR Key Synchronization

After the HELLO ends, XOR keys must be exchanged. This involves
sending a 3 byte sequence to the box, and receiving 3 bytes back:

- [0x2f, 0xVV, 0xWW] sent to ET312
- [0x21, 0xXX, 0xYY] is read from ET312

Where:

- 0xWW is a random unsigned 8-bit number, chosen by the host, used as
  the first key
- 0xXX is a random unsigned 8-bit number, chosen by the ET312, used as 
  the second key
- 0xWW/0xYY is a checksum, the 8-bit unsigned sum of the first two
  bytes, wrapped if the sum is > 255.

For instance:

- [0x2f, 0x04, 0x33] is sent to ET312
  - 0x04 is the first XOR key
  - 0x33 is the checksum (0x2f + 0x04)
- [0x21, 0x8f, 0xb0] is read from ET312, meaning
  - 0x8f is the XOR key
  - 0xb0 is the checksum (0x21 + 0x8f)

Note that the key chosen by the host need never change, it can simply
be hardcoded into the protocol implementation. Most implementations
simply use 0 for the host key, which simplifies calculation.

*** XOR Key Usage

Once the XOR keys are agreed upon, all further communication going
from host to ET312 is required to be encoded using the following
scheme, using ^ as an XOR operator:

Data Byte ^ (XOR Key 1 ^ XOR Key 2 ^ 0x55)

The part of the expression in parenthesis will be constant, and can be
pre-calculated and stored.

Only data sent from host to ET312 requires encryption, all data
received from the ET312 will be cleartext.

** Commands
*** Parameters
**** Parameter Read/Write Command Format

Commands sent to the ET-312 are a minimum of 3 bytes (minus checksum):

- Byte 0: Read or Write (Read: 0x3C, Write: 0x4D)
- Byte 1: Port Specifier (A: 0x40, B: 0x41)
- Byte 2: Parameter Specifier
- Byte 3-N: Data to be Written (Optional)

So, for example, to read (0x3C) the time on parameter (0x98) for port
A (0x40), we would send

0x3C 0x40 0x98

Note that this packet would need to be XOR'd using the algorithm laid
out in the "XOR Key Usage" section above.

**** Parameter Specifier/Format List
***** 0x98 - Time On

- 1 byte, Range 0-255, 255 is highest

***** 0x99 - Time Off

- 1 byte, Range 0-255, 255 is highest

***** 0x9a - Time Options

- Bits 0-4 (upper nibble): Off Options
- Bits 5-8 (lower nibble): On Options

***** 0xa5 - Current Level

- 1 byte, Range 128-255

***** 0xa6 - Minimum Level

- 1 byte, Range 128-255

***** 0xa7 - Maximum Level

- 1 byte, Range 128-255

***** 0xa8 - Level Rate

- 1 byte, Range 0-255, 0 is fastest

***** 0xac - Level Options

- Bits 0-4 (upper nibble): Min Options
- Bits 5-8 (lower nibble): Rate Options

***** 0xae - Frequency

- 1 byte, Range 8-255 (?!), 8 is fastest

***** 0xaf - Maximum Frequency

- 1 byte, Range 8-255 (?!), 8 is fastest

***** 0xb0 - Minimum Frequency

- 1 byte, Range 8-255 (?!), 8 is fastest

***** 0xb1 - Frequency Rate

- 1 byte, Range 0-255, 0 is fastest

***** 0xb5 - Frequency Options

- Bits 0-4 (upper nibble): Val Options
- Bits 5-8 (lower nibble): Rate Options

***** 0xb7 - Current Pulse Width

- 1 byte, Range 64-196 (?!)

***** 0xb8 - Minimum Pulse Width

- 1 byte, Range 64-196 (?!)

***** 0xb9 - Maximum Pulse Width

- 1 byte, Range 64-196 (?!)

***** 0xba - Pulse Width Rate

- 1 byte, Range 0-255, 0 is fastest

***** 0xbe - Width Options

- Bits 0-4 (upper nibble): Val Options
- Bits 5-8 (lower nibble): Rate Options

*** Memory
**** Commands
Outside of the initial key setup, talking to the ET312 happens through
2 functions. These resemble peek and poke, except that both can
send/receive between 1-8 bytes at a time.

Both functions take 16 bit addresses, which map into a virtual memory
space set up by the communications handler on the ET312. This memory
space looks like:

| Address Range | Description   |
|---------------+---------------|
| $0000 - $00ff | ROM? (256b)   |
| $4000 - $4400 | RAM (1k)      |
| $8000 - $8200 | EEPROM (512b) |

Reading past the end of these ranges will just loop the last valid
range.

***** Read Bytes

Reading a byte happens via a command with 3 byte length (minus checksum)

0xGc 0xHH 0xII

- 0xGc - High nibble is amount of data to receive from address, low
  nibble is always 0x0c
- 0xHH - High byte of address
- 0xII - Low byte of address

***** Write Bytes

Writing a byte happens via a command with 4 byte length (minus checksum)

0xGd 0xHH 0xII 0xJJ

- 0xGd - High nibble is amount of data to write to address, low nibble
  is always 0x0d
- 0xHH - High byte of address
- 0xII - Low byte of address
- 0xJJ - Value to set address to

**** Memory Layout Table
***** ROM

| Address | Description           |
|---------+-----------------------|
| $00fc   | Box Model             |
| $00fd   | Box Major Version     |
| $00fe   | Box Minor Version     |
| $00ff   | Box Interval Revision |

***** RAM

| Address       | Description                                                                 |
|---------------+-----------------------------------------------------------------------------|
| $4000         | (register file)                                                             |
| $4001         | (register file)                                                             |
| $4002         | (register file)                                                             |
| $4003         | (register file)                                                             |
| $4004         | (register file)                                                             |
| $4005         | (register file)                                                             |
| $4006         | (register file)                                                             |
| $4007         | (register file)                                                             |
| $4008         | (register file)                                                             |
| $4009         | (register file)                                                             |
| $400A         | (register file)                                                             |
| $400B         | (register file)                                                             |
| $400C         | (register file)                                                             |
| $400D         | (register file)                                                             |
| $400E         | (register file)                                                             |
| $400f         | Lockout Flags                                                               |
| $4010         | (register file)                                                             |
| $4011         | (register file)                                                             |
| $4012         | (register file)                                                             |
| $4013         | (register file)                                                             |
| $4010         | (register file)                                                             |
| $4015         | (register file)                                                             |
| $4016         | (register file)                                                             |
| $4017         | (register file)                                                             |
| $4018         | (register file)                                                             |
| $4019         | (register file)                                                             |
| $401A         | (register file)                                                             |
| $401B         | (register file)                                                             |
| $401C         | (register file)                                                             |
| $401D         | (register file)                                                             |
| $401E         | (register file)                                                             |
| $401f         | (register file)                                                             |
| $4020 - $405f | (ATMega 16 IO Registers)                                                    |
| $4060         | ?? (not used) - COMM_MAIN_CBLOCK_BASE                                       |
| $4061         | Multi Adjust Offset - CBLOCK_MULTI_A_OFFSET                                 |
| $4062         | Power Supply Voltage                                                        |
| $4063         | Battery Voltage                                                             |
| $4064         | CurrentLevel A - CBLOCK_POT_A_OFFSET                                        |
| $4065         | CurrentLevel B - CBLOCK_POT_B_OFFSET                                        |
| $4066         | Audio Level A                                                               |
| $4067         | Audio Level B                                                               |
| $4068         | 0x00 / 00                                                                   |
| $4069         | Pressed Button                                                              |
| $406A         | ? (some counter)                                                            |
| $406B         | 0x37 / 55                                                                   |
| $406C         | 0x2b / 43                                                                   |
| $406D         | Menu State                                                                  |
| $406E         | NOT USED                                                                    |
| $406F         | NOT USED                                                                    |
| $4070         | Trigger Action                                                              |
| $4071         | ?? does something when written to                                           |
| $4072         | ?? random number in random modes                                            |
| $4073         | ?? some timer                                                               |
| $4074         | ?? writing disables MA                                                      |
| $4075         | ?? writing does nothing, changes in random modes                            |
| $4076         | ?? 00                                                                       |
| $4077         | ?? 00                                                                       |
| $4078         | ?? (copy of CurrentMode?)                                                   |
| $4079         | Lowest Selectable Mode                                                      |
| $407A         | Highest Selectable Mode                                                     |
| $407b         | CurrentMode                                                                 |
| $407c         | ?? Oscillator Ch A?                                                         |
| $407d         | ?? Oscillator Ch a?                                                         |
| $407e         | ?? Oscillator Ch B?                                                         |
| $407F         | ?? Oscillator Ch B?                                                         |
| $4080         | ?? (gets set to 0x00 when routine loaded)                                   |
| $4083         | Control Flags - COMM_CONTROL_FLAG (CONTROL_FLAG_DISABLE_SWITCHES_MASK = 32) |
| $4084         | ?? (gets set to 0x00 when routine loaded)                                   |
| $4085         | ?? (gets set to 0x03 when routine loaded)                                   |
| $4086         | Multi Adjust Range High End                                                 |
| $4087         | Multi Adjust Range Low End                                                  |
| $4088         | Routine timer low                                                           |
| $4089         | Routine timer high                                                          |
| $408A         | ?? (gets set to 0x00 when routine loaded)                                   |
| $408B         | ?? (some timer)                                                             |
| $408C         | ?? (gets set to 0x00 when routine loaded)                                   |
| $408D         | ?? (used by torment routine)                                                |
| $408E         | ?? (used by torment routine)                                                |
| $408F         | ?? (gets set to 0x00 when routine loaded)                                   |
| $4090         | ?? (Channel-Specific)                                                       |
| $4091         | ?? (Channel-Specific)                                                       |
| $4092         | ?? (routine specific counters)                                              |
| $4093         | ?? (routine specific counters)                                              |
| $4094         | ?? (routine specific counters)                                              |
| $4095         | ?? (routine specific counters)                                              |
| $4096         | ?? (routine specific counters)                                              |
| $4097         | ?? (routine specific counters)                                              |
| $4098         | CurrentGateOnTime                                                           |
| $4099         | CurrentGateOffTime                                                          |
| $409A         | CurrentGateSelect                                                           |
| $409B         | ?? (counter for gate)                                                       |
| $409C         | Ramp (For Mode Switch)                                                      |
| $40A0         | ?? (routine specific counters)                                              |
| $40A1         | ?? (routine specific counters)                                              |
| $40A2         | ?? (routine specific counters)                                              |
| $40A3         | ?? (routine specific counters)                                              |
| $40A4         | ?? (routine specific counters)                                              |
| $40A5         | CurrentIntModValue                                                          |
| $40A6         | CurrentIntModMin                                                            |
| $40A7         | CurrentIntModMax                                                            |
| $40A8         | CurrentIntModRate                                                           |
| $40A9         | ?? (routine specific counters)                                              |
| $40AA         | ?? (routine specific counters)                                              |
| $40AB         | ?? (routine specific counters)                                              |
| $40ac         | CurrentIntModSelect                                                         |
| $40AD         | ?? (routine specific counters)                                              |
| $40ae         | CurrentFreqValue                                                            |
| $40af         | CurrentFreqMin                                                              |
| $40b0         | CurrentFreqRate                                                             |
| $40B1         | ?? (routine specific counters)                                              |
| $40b2         | ?? (routine specific counters)                                              |
| $40b3         | ?? (routine specific counters)                                              |
| $40b4         | ?? (routine specific counters)                                              |
| $40b5         | CurrentFreqSelect                                                           |
| $40b6         | ?? (routine specific counters)                                              |
| $40b7         | CurrentWidthValue                                                           |
| $40b8         | CurrentWidthMin                                                             |
| $40b9         | CurrentWidthMax                                                             |
| $40ba         | CurrentWidthRate                                                            |
| $40be         | CurrentWidthSelect                                                          |
| $40b6 - ??    | (routine specific counters)                                                 |
| $40c0 - $4177 | Space for User Routine Scratchpad A                                         |
| $4180 - $41c0 | Repeat Settings for Channel B                                               |
| $41c0 - $41d0 | ?? (weird stuff)                                                            |
| $41d0 - $41ef | Space for User Routine Scratchpad B                                         |
| $41f0         | - ?? (Counter)                                                              |
| $41f1         | - ?? (Schreibzugriff crasht)                                                |
| $41f2         | - ?? (Unklar)                                                               |
| $41f3         | CurrentTopMode (written during routine write)                               |
| $41f4         | PowerLevel                                                                  |
| $41f5         | SplitAModeNum                                                               |
| $41f6         | SplitBModeNum                                                               |
| $41f7         | Favourite Mode                                                              |
| $41F8         | Advanced Parameter: RampLevel                                               |
| $41F9         | Advanced Parameter: RampTime                                                |
| $41FA         | Advanced Parameter: Depth                                                   |
| $41FB         | Advanced Parameter: Tempo                                                   |
| $41FC         | Advanced Parameter: Frequency                                               |
| $41FD         | Advanced Parameter: Effect                                                  |
| $41FE         | Advanced Parameter: Width                                                   |
| $41FF         | Advanced Parameter: Pace                                                    |
| $4200 - $43FF | Stack and various strange stuff                                             |
***** EPROM
| Address | Description                                                              |
|---------+--------------------------------------------------------------------------|
| $8000   | ?                                                                        |
| $8001   | ?                                                                        |
| $8002   | BoxSerial1                                                               |
| $8003   | BoxSerial2                                                               |
| $8004   | ?                                                                        |
| $8005   | ?                                                                        |
| $8006   | ELinkSig1 - ELINK_SIG1_ADDR (ELINK_SIGVER1_SIG1 = 1 / LINK_NEW_SIG1 = 0) |
| $8007   | ELinkSig2 - ELINK_SIG2_ADDR (ELINK_SIGVER1_SIG2 = 1 / LINK_NEW_SIG2 = 0) |
| $8008   | TopMode NonVolatile (written during routine write)                       |
| $8009   | PowerLevel                                                               |
| $800A   | SplitAModeNum                                                            |
| $800B   | SplitBModeNum                                                            |
| $800C   | Favourite Mode                                                           |
| $800D   | Advanced Parameter: RampLevel                                            |
| $800E   | Advanced Parameter: RampTime                                             |
| $800F   | Advanced Parameter: Depth                                                |
| $8010   | Advanced Parameter: Tempo                                                |
| $8011   | Advanced Parameter: Frequency                                            |
| $8012   | Advanced Parameter: Effect                                               |
| $8013   | Advanced Parameter: Width                                                |
| $8014   | Advanced Parameter: Pace                                                 |
| $8015   | ?                                                                        |
| $8016   | ?                                                                        |
| $8017   | ?                                                                        |
| $8018   | Start Vector User 1 - COMM_USER_BASE                                     |
| $8019   | Start Vector User 2                                                      |
| $801A   | Start Vector User 3                                                      |
| $801B   | Start Vector User 4                                                      |
| $801C   | Start Vector User 5                                                      |
| $801D   | Start Vector User 6                                                      |
| $801E   | ?                                                                        |
| $801F   | ?                                                                        |
| $8020   | Space for User Routines A                                                |
| $8040   | Space for User Routines B                                                |
| $8100   | Space for User Routines C                                                |
| $8120   | Space for User Routines D                                                |
| $8200   | END                                                                      |

**** Tables
***** Action Value Table ($4070)
| Value | Description                                    |
|-------+------------------------------------------------|
|  0x00 | Reset Current Routine                          |
|  0x02 | Display Status Screen                          |
|  0x03 | Select current Menu Item                       |
|  0x04 | Exit Menu                                      |
|  0x05 | Start "Favourite" Routine                      |
|  0x06 | (Failure 16)                                   |
|  0x07 | (Display value of $41A1 / Change with UP/DOWN) |
|  0x08 | display next menu item                         |
|  0x09 | display previous menu item                     |
|  0x0a | Show Main Menu                                 |
|  0x0b | Jump to split mode settings menu               |
|  0x0c | Activates Split Mode                           |
|  0x0d | (Displays a numer)                             |
|  0x0e | (Displays a numer)                             |
|  0x0f | Show Advanced Menu                             |
|  0x10 | next mode                                      |
|  0x11 | previous mode                                  |
|  0x12 | (random behaviour)                             |
|  0x13 | (display broken character)                     |
|  0x14 | (display 00)                                   |
|  0x15 | Display "Shut off Power"                       |
|  0x16 | (mutes or glitches current routine)            |
|  0x17 | hard reset                                     |
|  0x18 | Stop Routine (Mute)                            |
|  0x19 | swap channels                                  |
|  0x1a | Copies channel a to channel b                  |
|  0x1b | Copies channel b to channel a                  |
|  0x1c | (do this three times and lose serial)          |
|  0x1d | (no visible effect)                            |
|  0x1e | (Failure 04)                                   |
|  0x1f | (Failure 80)                                   |
|  0x20 | (Glitch channel B in some routines)            |
|  0x21 | (no visible effect)                            |
|  0x22 | (no visible effect)                            |
|  0x23 | (no visible effect)                            |
|  0x24 | (display glitch)                               |
|  0x25 | (Failure 00)                                   |
|  0x26 | (Failure 00)                                   |
|  0x27 | (Failure 00)                                   |
***** Phase Value Table ($4083)
| Value | Description                 |
|-------+-----------------------------|
|  0x01 | Phase Control               |
|  0x02 | Mute                        |
|  0x04 | Phase Control 2             |
|  0x08 | Phase Control 3             |
|  0x20 | Disable Frontpanel Switches |
|  0x40 | Mono Mode (off=Stereo)      |


